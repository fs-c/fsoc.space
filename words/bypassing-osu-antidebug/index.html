<!DOCTYPE html>
<html lang="en"><head><meta charset="utf-8"></meta><meta name="viewport"  content="width=device-width, initial-scale=1"></meta><meta name="author"  content="fsoc"></meta><meta name="author"  content="Laurenz Weixlbaumer"></meta><link href="/styles/base.css"  rel="stylesheet"></link><link href="/styles/font.css"  rel="stylesheet"></link><title>Bypassing osu! Anti-Debug</title><meta name="description"  content="null"></meta><link href="/styles/syntax-theme.css"  rel="stylesheet"></link></head><body><div class="min-h-screen flex flex-col h-full "><header class="container border-b border-gray-300 dark:border-gray-600 mt-4 mb-4 pb-4"><div class="prose dark:prose-invert text-black dark:text-white"><a href="/">fsoc</a> / <a href="/words">words</a></div></header><main class="container prose dark:prose-invert lg:prose-lg pb-8"><h1 class="mt-4">Bypassing osu! Anti-Debug</h1><aside class="mb-4 flex flex-row justify-between"><small>Published on 16/01/2023</small><small><a href="https://github.com/fs-c/fsoc.space/edit/workbench/posts/bypassing-osu-antidebug.md">Edit on github</a></small></aside><p>Since the last time I've looked at it, <a href="https://osu.ppy.sh/home">osu!</a> has received some anti-cheat improvements with new anti-debugging measures among them. Most of them are bypassed just fine by <a href="https://github.com/x64dbg/ScyllaHide">ScyllaHide</a>, but at least one isn't. For each new process that is started, osu! calls <a href="https://learn.microsoft.com/en-us/windows/win32/api/winver/nf-winver-getfileversioninfoa"><code>GetFileVersionInfo</code></a> and checks the executable description against a blacklist. I found the process of discovering and bypassing this interesting enough to be worth sharing.</p><p>First, let me establish what we're working with. Osu! is written in C# and the binaries are obfuscated heavily, I wasn't able to decompile them to something readable in a reasonable amount of time. So I figured this would be an interesting exercise in dynamic analysis. The binary on disk is a black box, I only looked at what is happening at runtime. The symptom we are looking to alleviate: Osu will immediately close itself if it detects that a debugger is running.</p><p>The first thing that came to my mind was to (blindly) hook some Windows APIs that I suspected osu! might use to detect that a debugger is running, for example <code>EnumWindows</code> to read window titles. I can't think of all of them anymore, but nothing I tried worked. Really, what I wanted was to hook <em>all</em> Windows APIs. After some searching I ended up with <a href="http://www.rohitab.com/apimonitor">API Monitor</a> from rohitab, which appears to do exactly that. It's important to note that the osu! executable is only a launcher for the real game, so API Monitor needs to be attached after full startup. I also had to change the monitoring method when attaching to processes to "Remote Thread (Extended)".</p><p>When selecting all supported APIs, this will log <em>a lot</em> of calls and significantly slow down execution of the monitored program. I played around with this for a little and ended up purposefully triggering the shutdown by opening x64dbg. As expected, we see API calls in reaction to this originating from osu!auth.dll, which appears to contain the anti-debug logic.</p><figure role="img"><img src="https://i.imgur.com/aeGbPWh.png" alt=""><figcaption></figcaption></figure><p>This just initializes a string with the program that was just started, but taking a look at the stack reveals that this is called as a part of <code>GetFileVersionInfoW</code>. In fact, these calls happen for every application that is started while osu! is running.</p><figure role="img"><img src="https://i.imgur.com/B91ed1S.png" alt=""><figcaption></figcaption></figure><p>The buffer returned by <code>GetFileVersionInfoW</code> contains (predictably) version information, but crucially it also optionally contains other values like a company name or a file description. The usual call structure for fetching and querying this buffer appears to be something like</p><pre><code class="language-cpp">const auto size = GetFileVersionInfoSizeW("path/to/file.exe");

if (size) {
    GetFileVersionInfoW("path/to/file.exe", ..., version_info_buffer);

    VerQueryValueW(version_info_buffer, "\StringFileInfo\lang-codepage\string-name", &amp;value, ...);
}</code></pre><p>Accordingly, when hooking these functions we get the following output for every program that is started while osu! is running.</p><figure role="img"><img src="https://i.imgur.com/APibLGu.png" alt=""><figcaption></figcaption></figure><p>So osu! is reading the <code>FileDescription</code> and appears to be checking it against a blacklist. To confirm this theory I used <a href="http://www.angusj.com/resourcehacker/">Resource Hacker</a> to change the version info of x32dbg.</p><figure role="img"><img src="https://i.imgur.com/RqcOlg3.png" alt=""><figcaption></figcaption></figure><p>Indeed, changing it to anything but x64dbg will cause osu! to ignore it. This is the solution that I actually use, considering that there are only a handful of blacklisted processes. But for completeness sake, it is also possible to hook <code>GetFileVersionInfoSizeW</code> and always return zero. That way osu! will never even call <code>GetFileVersionInfoW</code>. But this requires injecting a DLL every time osu! is started, which is somewhat cumbersone.</p><script src="https://unpkg.com/prismjs@v1.x/components/prism-core.min.js"></script><script src="https://unpkg.com/prismjs@v1.x/plugins/autoloader/prism-autoloader.min.js"></script></main></div><footer class="flex flex-row justify-between prose dark:prose-invert container text-md py-3 mb-1 border-t border-gray-300 dark:border-gray-600 mt-4"><p class="m-0">Built with <a href="https://github.com/fs-c/dhow/tree/rewrite">fs-c/dhow</a>.</p><a href="/legal">imprint & privacy</a></footer></body></html>