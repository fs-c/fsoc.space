<!DOCTYPE html>
<html lang="en"><head><meta charset="utf-8"></meta><meta name="viewport"  content="width=device-width, initial-scale=1"></meta><meta name="author"  content="fsoc"></meta><meta name="author"  content="Laurenz Weixlbaumer"></meta><link href="/styles/base.css"  rel="stylesheet"></link><link href="/styles/font.css"  rel="stylesheet"></link><meta name="description"  content="Writeup for the Matriochka task(s) from the Nuit du Hack CTF Quals 2016."></meta><link href="/styles/syntax-theme.css"  rel="stylesheet"></link><meta name="description"  content="Writeup for the filechecker task from the Netzwache CTF 2016."></meta><link href="/styles/syntax-theme.css"  rel="stylesheet"></link><meta name="description"  content="Writeups for two tasks from the Sharif University CTF 2016."></meta><link href="/styles/syntax-theme.css"  rel="stylesheet"></link><meta name="description"  content="Dynamically generating polygons and smoothing out their edges."></meta><link href="/styles/syntax-theme.css"  rel="stylesheet"></link><meta name="description"  content="Writing a small patcher to remove ads from an electron app with NodeJS."></meta><link href="/styles/syntax-theme.css"  rel="stylesheet"></link><meta name="description"  content="So I added live reloading to dhow, why do I think this is such a big deal"></meta><link href="/styles/syntax-theme.css"  rel="stylesheet"></link><meta name="description"  content="Reversing an encryptor written in Java, decidedly overusing streams."></meta><link href="/styles/syntax-theme.css"  rel="stylesheet"></link><meta name="description"  content="TODO"></meta><link href="/styles/syntax-theme.css"  rel="stylesheet"></link></head><body><div class="min-h-screen flex flex-col h-full "><header class="container border-b border-gray-300 dark:border-gray-600 mt-4 mb-4 pb-4"><div class="prose dark:prose-invert text-black dark:text-white"><a href="/">fsoc</a> / <a href="/words">words</a></div></header><main class="container prose dark:prose-invert lg:prose-lg pb-8"><h1 class="mt-4">PCI passthrough</h1><aside class="mb-4 flex flex-row justify-between"><small>Published on 2022-8-22</small><small><a href="https://github.com/fs-c/fsoc.space/edit/workbench/posts/pci-passthru.md">Edit on github</a></small></aside><p>https://wiki.archlinux.org/title/PCI<em>passthrough</em>via<em>OVMF<br>https://askubuntu.com/questions/1406888/ubuntu-22-04-gpu-passthrough-qemu</p><ol><li>enable iommu (vt-d) in mainboard</li></ol><ol><li>enable iommu support in kernel (edit /etc/default/grub and run update-grub)</li></ol><ol><li>install liquorix kernel, enable acs override (pcie<em>acs</em>override=downstream in grub), reboot</li></ol><ol><li>identify iommu groups to isolate</li><li><code></code><code>bash</li><li>#!/bin/bash</li><li>-s nullglob</li><li>g in $(find /sys/kernel/iommu<em>groups/</em> -maxdepth 0 -type d | sort -V); do</li><li>cho "IOMMU Group ${g##<em>/}:"</li><li>or d in $g/devices/<em>; do</li><li>cho -e "\t$(lspci -nns ${d##<em>/})"</li><li>one;</li><li>done;</li><li><code></code><code></li><li>it only contains gpu/audio not a bus or something.</li><li><code></code><code></li><li>Group 13:</li><li>GA compatible controller </li><li>Group 14:</li><li>udio device </li><li><code></code><code></li></ol><ol><li>isolate the gpu. identify the drivers which are currently in use for the devices in the given groups with lspci -nnk and blacklist them. create /etc/modprobe.d/vfio.conf</li><li><code></code><code></li><li>nouveau</li><li>snd<em>hda</em>intel</li><li>i2c<em>nvidia</em>gpu</li><li><code></code><code></li><li>tell vfio to isolate the devices in the groups you identified earlier</li><li><code></code><code></li><li>vfio-pci ids=10de:1f02,10de:10f9,10de:1ada,10de:1adb</li><li><code></code><code></li></ol><p>then do sudo update-initramfs -u to apply the changes</p><ol><li>reboot and ensure lspci -nnk shows vfio-pci in use</li></ol><ol><li>8.</li></ol><script src="https://unpkg.com/prismjs@v1.x/components/prism-core.min.js"></script><script src="https://unpkg.com/prismjs@v1.x/plugins/autoloader/prism-autoloader.min.js"></script></main></div><footer class="flex flex-row justify-between prose dark:prose-invert container text-md py-3 mb-1 border-t border-gray-300 dark:border-gray-600 mt-4"><p class="m-0">Built with <a href="https://github.com/fs-c/dhow/tree/rewrite">fs-c/dhow</a>.</p><a href="/legal">imprint & privacy</a></footer></body></html>